# OpenClaw 配置踩坑记录

> 记录日期：2026-02-27
> 记录人：德米 & 伟烨
> 遵循格式：现象 → 原因 → 解决方案 → 预防措施

---

## 坑 1：memory-lancedb-pro 插件导致 Gateway 启动失败

### 现象
- 配置好插件后重启 Gateway
- 重启后插件配置消失，自动回滚到之前状态
- 或者 Gateway 无法正常启动

### 原因
1. **插件兼容性问题**：插件加载失败导致 Gateway 启动异常
2. **配置回滚机制**：OpenClaw 在检测到启动失败时会自动回滚配置
3. **依赖未满足**：可能需要特定版本的 Node.js 或其他依赖

### 解决方案
1. **立即恢复**：使用备份脚本恢复
   ```powershell
   agent-backup restore before_lancedb_install_20260227_000350
   ```
2. **手动清理**：删除插件配置，恢复干净状态
3. **暂时放弃**：等插件更新或 OpenClaw 版本更新后再尝试

### 预防措施
- ✅ **安装任何插件前先备份**：`agent-backup create before_xxx`
- ✅ **逐步验证**：每改一步配置就重启测试，不要一次性改太多
- ✅ **保留干净基线**：确保有一个 100% 可用的备份
- ❌ **不要急着追新**：插件等别人先用稳定了再装

---

## 坑 2：ClawHub 速率限制导致无法安装 Skills

### 现象
- `npx clawhub install xxx` 命令卡住或超时
- 错误信息：`Rate limit exceeded` 或 `Timeout`
- 无法搜索或安装新技能

### 原因
- ClawHub API 有访问频率限制
- 短时间内多次请求会被限流
- 网络不稳定也会导致超时

### 解决方案
1. **等待**：等 5-10 分钟后再试
2. **避开高峰期**：晚上/周末可能更稳定
3. **手动下载**：直接从 GitHub 下载 zip 包解压到 `skills_custom/`
4. **批量安装失败时逐个试**：不要一次装多个

### 预防措施
- ⏰ **合理安排**：一次只装 1-2 个 skill，装完测试成功再继续
- 📦 **本地备份**：装好的 skill 文件夹单独备份，下次直接复制
- 🔄 **有备无患**：常用 skill 从 GitHub 下载保存到本地

---

## 坑 3：API Key 格式或配置错误

### 现象
- 配置完成后测试不生效
- 日志显示认证失败或 API 错误
- 某些功能突然失效

### 原因
1. **Key 复制不完整**：前后多了空格或少了字符
2. **环境变量未加载**：`${XXX_API_KEY}` 引用错误
3. **权限不足**：API Key 没有开通对应功能
4. **格式错误**：JSON 配置格式不对（少逗号、引号不匹配）

### 解决方案
1. **验证 JSON 格式**：
   ```bash
   node -e "JSON.parse(require('fs').readFileSync('openclaw.json'))"
   ```
2. **检查 Key 有效性**：用 curl 或简单脚本测试 API 是否可用
3. **查看日志**：`Get-Content "$env:TEMP\openclaw\openclaw-*.log" -Tail 50`
4. **重新生成**：去官网重新生成 Key

### 预防措施
- ✅ **配置后立即验证**：改完配置先用 JSON 验证工具检查
- ✅ **备份 credentials**：`credentials/` 文件夹定期备份
- ✅ **敏感信息脱敏**：分享配置时记得打码

---

## 坑 4：插件配置丢失/回滚

### 现象
- 明明配置了插件，重启后配置消失
- `openclaw.json` 被重置为旧版本
- 新加的插件配置不见了

### 原因
1. **启动失败自动回滚**：Gateway 检测到错误配置会回滚
2. **多配置源冲突**：service 配置和 cli 配置不一致
3. **手动修改错误**：JSON 格式错误导致解析失败

### 解决方案
1. **查看当前生效配置**：
   ```bash
   openclaw config get
   ```
2. **手动恢复**：从备份中复制 `openclaw.json`
3. **编辑前备份**：改配置前先 `agent-backup create`

### 预防措施
- 🔄 **改配置三步走**：备份 → 修改 → 验证 → 重启
- 📋 **版本控制**：重要配置变更记录到 git 或备份多个版本
- 🧪 **测试环境**：先在测试环境验证再应用到生产

---

## 坑 5：PowerShell 脚本编码问题

### 现象
- 执行 .ps1 脚本时出现乱码
- 错误信息包含乱码字符
- 脚本无法识别命令参数

### 原因
- 文件编码不是 UTF-8 with BOM
- Windows 默认使用 GBK/GB2312 编码
- 特殊字符（如中文引号、尖括号）导致解析错误

### 解决方案
1. **统一使用 UTF-8 编码保存文件**
2. **避免特殊字符**：脚本中使用英文注释和输出
3. **使用 ASCII 安全字符**：尽量少用中文标点符号

### 预防措施
- 📝 **编码检查**：保存前确认文件编码为 UTF-8
- 🌐 **英文优先**：脚本、配置文件尽量用英文
- 🔤 **简单字符集**：避免使用 `→`、`→` 等特殊符号

---

## 坑 6：Gateway 重启方式不当

### 现象
- 配置改了但好像没生效
- 出现奇怪的行为或报错
- 连接中断或消息丢失

### 原因
- **reload vs restart**：有些配置需要完全重启才能生效
- **会话未清理**：旧会话还在使用旧配置
- **后台进程残留**：之前的 Gateway 进程没有完全停止

### 解决方案
1. **完全重启**：
   ```bash
   openclaw gateway stop
   # 等待几秒
   openclaw gateway start
   ```
2. **检查状态**：`openclaw gateway status`
3. **强制重启**：如果有残留进程，手动结束后再启动

### 预防措施
- ⏳ **耐心等待**：stop 后等 3-5 秒再 start
- ✅ **确认状态**：重启后用 status 命令确认运行正常
- 🧹 **定期清理**：长时间运行后定期重启释放资源

---

## 核心经验总结

### 🎯 黄金法则

1. **备份先行**
   ```
   任何操作前 → agent-backup create before_xxx
   ```

2. **小步快跑**
   ```
   一次只改一点 → 测试 → 再改下一点
   ```

3. **验证确认**
   ```
   改配置 → 验证 JSON → 重启 → 测试功能
   ```

4. **记录沉淀**
   ```
   每次踩坑 → 立即记录 → 下次直接查
   ```

### 📂 推荐的工作流程

```
1. 新任务/配置变更
   ↓
2. 创建备份（agent-backup create）
   ↓
3. 小步修改配置
   ↓
4. 验证格式（node JSON.parse）
   ↓
5. 重启 Gateway
   ↓
6. 测试功能
   ↓
7. 成功 → 庆祝！
   失败 → 恢复备份 → 分析原因 → 记录踩坑
```

### ⚠️ 千万不要做的事

- ❌ 一次性安装多个插件
- ❌ 没有备份就修改配置
- ❌ 忽略 JSON 语法错误
- ❌ 不测试就继续下一步
- ❌ 跳过日志直接重试

---

**下次再配置 OpenClaw，先查这份文档，能省 80% 的时间！**
